rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // Check roles_admin collection for admin status
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isActiveStudent() {
      // Check if user is signed in AND not blocked in their profile
      // Note: We assume non-admins are students by default, but we should verify status.
      // This requires reading the user document, which costs 1 read.
      // For simplicity/performance, we might skip the status check on every read if not critical, 
      // but requirement says 'block student account', so we MUST enforce it.
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isSignedIn() && (userDoc == null || userDoc.data.status != 'blocked');
    }

    // --- Collection Rules ---

    // 1. Users (Students/Admins)
    // Students can read/write their own profile (for onboarding). Admins manage all.
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId); // Initial sign-up
      allow update: if isOwner(userId) || isAdmin(); // Onboarding details or Admin blocking
      allow delete: if isAdmin();
    }

    // 2. Documents (The PDFs)
    // Readable by active students. Writable by Admins only.
    match /documents/{docId} {
      allow get, list: if isAdmin() || isActiveStudent();
      allow create, update, delete: if isAdmin();
    }
    
    // 3. Download Logs (Tracking)
    // Students create logs when downloading. Admins read stats.
    match /downloads/{logId} {
      allow create: if isActiveStudent();
      allow read, list: if isAdmin();
    }

    // 4. Login Logs (Tracking)
    // Created on login.
    match /login_logs/{logId} {
      allow create: if isSignedIn();
      allow read, list: if isAdmin();
    }

    // 5. Admin Roles (Same as before)
    match /roles_admin/{userId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}